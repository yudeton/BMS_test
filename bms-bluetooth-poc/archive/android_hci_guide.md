# Android HCI 日誌擷取指南
完整指南：如何捕獲 Smart BMS app 的真實藍牙通訊協議

## 🎯 目標
透過 Android 手機的 HCI 日誌功能，捕獲 Smart BMS app 與 DALY BMS 之間的真實藍牙通訊，從而破解正確的協議格式。

## 📱 前提條件
- Android 手機（Android 4.4 以上）
- Smart BMS app 能正常連接您的 BMS
- 電腦（用於分析日誌）

## 🔧 步驟一：啟用開發者選項

### 1. 開啟開發者選項
1. 進入 **設定** → **關於手機**
2. 連續點擊 **版本號碼** 7次
3. 出現「您現在已是開發人員」訊息

### 2. 進入開發者選項
1. 返回 **設定** 主頁面
2. 找到 **開發者選項**（通常在系統設置裡）

## 📊 步驟二：啟用藍牙 HCI 日誌

### 1. 找到 HCI 日誌選項
在開發者選項中尋找以下選項之一：
- ✅ **啟用藍牙 HCI 偵錯記錄**
- ✅ **Bluetooth HCI snoop log**
- ✅ **藍牙 HCI 記錄**

### 2. 啟用日誌記錄
1. **開啟**該選項
2. 部分手機會顯示日誌文件保存路徑，記下來

### 3. 常見日誌路徑
不同手機的日誌保存位置：
```
Samsung: /sdcard/btsnoop_hci.log
Google Pixel: /sdcard/Android/data/btsnoop_hci.log
HTC: /sdcard/btsnoop_hci.log
其他: /data/misc/bluetooth/logs/btsnoop_hci.log
```

## 🎬 步驟三：錄製 Smart BMS 通訊

### 1. 準備錄製
1. **重新啟動**手機（清空舊日誌）
2. 確認 **Smart BMS app 已關閉**
3. 確認 **BMS 藍牙未連接**

### 2. 開始錄製
1. 打開 **Smart BMS app**
2. 執行以下操作（按順序）：
   - 搜尋並連接 BMS
   - 查看主界面（電壓、電流、SOC）
   - 切換到電芯電壓頁面
   - 切換到溫度頁面  
   - 切換到設備狀態頁面
3. 在每個頁面**停留 5-10 秒**

### 3. 完成錄製
1. 關閉 Smart BMS app
2. **關閉**開發者選項中的 HCI 日誌
3. 記錄操作時間（用於後續分析）

## 💻 步驟四：提取日誌文件

### 方法 1：通過文件管理器
1. 使用手機的**文件管理器**
2. 導航到日誌路徑
3. 找到 `btsnoop_hci.log` 文件
4. **複製**到可存取的位置（如下載文件夾）
5. 透過 USB、雲端硬碟等方式傳到電腦

### 方法 2：通過 ADB（推薦）
如果您的電腦安裝了 ADB：
```bash
# 連接手機，啟用 USB 調試
adb devices

# 提取日誌文件
adb pull /sdcard/btsnoop_hci.log ./smart_bms_hci.log

# 或嘗試其他路徑
adb pull /data/misc/bluetooth/logs/btsnoop_hci.log ./smart_bms_hci.log
```

## 🔍 步驟五：分析日誌

### 使用 Wireshark 分析
1. 下載並安裝 [Wireshark](https://www.wireshark.org/)
2. 開啟 `btsnoop_hci.log` 文件
3. 過濾 BMS 的 MAC 地址：
   ```
   bluetooth.addr == 41:18:12:01:37:71
   ```
4. 尋找 GATT 寫入操作：
   ```
   btatt.opcode == 0x52
   ```

### 使用我們的 Python 分析工具
創建一個專用的 HCI 日誌分析工具（見下方代碼）。

---

## 🛠️ 故障排除

### 問題 1：找不到開發者選項
**解決方法：**
- 確認點擊了正確的「版本號碼」
- 有些手機需要點擊「內部版本號」
- 部分手機在「系統」→「關於手機」裡

### 問題 2：找不到 HCI 日誌選項  
**解決方法：**
- 搜索「HCI」、「snoop」、「藍牙」等關鍵字
- 部分手機該選項名稱不同
- Android 9+ 部分廠商隱藏了此選項

### 問題 3：找不到日誌文件
**解決方法：**
- 嘗試不同的路徑
- 使用文件搜索功能搜索「btsnoop」
- 確認已啟用日誌記錄並執行過藍牙操作

### 問題 4：文件權限問題
**解決方法：**
```bash
# 使用 ADB 獲取 root 權限（需要 root 手機）
adb shell
su
cp /data/misc/bluetooth/logs/btsnoop_hci.log /sdcard/
```

### 問題 5：檔案過大
**解決方法：**
- 只錄製必要的操作（5-10分鐘）
- 錄製前重啟手機清空舊日誌
- 關閉其他藍牙設備避免干擾

---

## 📋 分析清單

成功提取日誌後，尋找以下內容：

### ✅ 關鍵信息
- [ ] BMS 的 MAC 地址通訊記錄
- [ ] GATT 寫入操作（Write Command/Request）
- [ ] GATT 通知數據（Notification）
- [ ] 特徵值 UUID（fff2, fff1）
- [ ] 初始化序列（連接後的前幾個命令）

### ✅ 重要數據
- [ ] 每個頁面切換時的命令
- [ ] 命令的十六進制內容
- [ ] 響應的十六進制內容
- [ ] 命令發送的時間序列

---

## 🎯 預期結果

通過這個過程，您將獲得：
1. **真實的初始化序列** - Smart BMS app 連接時發送的命令
2. **頁面切換命令** - 獲取不同數據的具體命令
3. **正確的協議格式** - 包含校驗和、地址等
4. **數據映射關係** - 命令與響應的對應關係

有了這些信息，我們就能創建一個完全兼容的 Python 通訊工具！

---

## ⚠️ 注意事項

1. **隱私安全**：HCI 日誌包含所有藍牙通訊，使用完畢後記得關閉
2. **存儲空間**：日誌文件可能很大，注意手機存儲空間
3. **電池消耗**：日誌記錄會增加電池消耗
4. **僅限學習**：只用於個人學習和研究，不要用於商業用途

---

## 🤝 需要協助？

如果在執行過程中遇到問題，請提供：
1. 手機型號和 Android 版本
2. 具體的錯誤信息或截圖
3. 執行到哪個步驟遇到問題

這樣我可以提供更針對性的協助！