# BMS 藍牙通訊專案 TODO 清單

## 📊 專案狀態總結
**最後更新**: 2025-08-28  
**專案階段**: 協議破解中  
**當前進度**: 40%

---

## 🎯 重要發現

### ✅ 已確認資訊
- **BMS 設備**: DL-411812013771
- **MAC 地址**: `41:18:12:01:37:71`
- **硬體版本**: H2.1_103E_30XF
- **軟體版本**: 12_250416_K00T
- **SN碼**: 226KD020700867
- **藍牙特徵值**:
  - 寫入通道: `0000fff2-0000-1000-8000-00805f9b34fb`
  - 通知通道: `0000fff1-0000-1000-8000-00805f9b34fb`

### 🔑 協議突破
- **錯誤協議**: A5 80 格式 (DALY 舊協議) - 只收到回音
- **正確協議**: DD A5 格式 (通用中國 BMS 協議/Smart BMS 協議)
  - 讀取基本信息: `DD A5 03 00 FF FD 77`
  - 讀取電芯電壓: `DD A5 04 00 FF FC 77`
  - 讀取硬體信息: `DD A5 05 00 FF FB 77`
  - MOSFET 控制: `DD 5A E1 02 00 00 FF 1D 77`

### 📱 參考數據 (來自 Smart BMS app)
- **總電壓**: 26.6V
- **電量**: 49.8% SOC
- **電芯數**: 8串
- **單電芯電壓**: ~3.32V
- **狀態**: 正常工作

### 🔍 最終問題分析
1. **協議格式** ✅ - DD A5 格式確認正確
2. **校驗和算法** ✅ - 使用 0x10000 - sum(data) 計算正確
3. **BLE 連接** ✅ - 連接和特徵值都正常
4. **持續回音問題** ❓ - BMS 完美回音所有命令

### 🤔 回音問題可能原因
1. **MOSFET 保護模式**: "GPS or soft switch turn off MOS" - BMS 在保護狀態
2. **韌體特殊要求**: K00T 韌體可能需要特殊初始化序列
3. **需要認證/密碼**: 可能需要先通過認證才能讀取數據
4. **測試模式**: BMS 可能處於測試/配置模式

### 💡 建議解決方案
1. **使用 Smart BMS app 開啟 MOSFET**
2. **分析 Android HCI 日誌** - 捕獲 app 的真實通訊序列
3. **尋找韌體特定文檔** - 針對 K00T 版本的協議說明
4. **嘗試其他初始化序列** - 可能需要特殊的喚醒/認證命令

---

## 🔍 測試記錄

### 已測試的協議格式
| 協議類型 | 測試結果 | 備註 |
|---------|---------|------|
| A5 UART | ⚠️ 部分成功 | 收到回音，格式正確 |
| D2 Modbus | ❌ 失敗 | 無響應 |
| Smart BMS (DD A5) | ❌ 失敗 | 不兼容 |
| CAN 協議轉換 | ❌ 失敗 | 格式不匹配 |
| AI 智能探測 | ⚠️ 部分成功 | 發現高分命令但仍是回音 |

### 測試結果分析
```
發送: A58093080000000000000000C0
接收: A58093080000000000000000C0 (完全相同 - 回音)
解析: 充電MOSFET: 關閉, 放電MOSFET: 關閉
```

---

## 🛠️ 工具清單

### 核心工具
- [x] `scanner.py` - 藍牙設備掃描器 ✅
- [x] `connector.py` - 基礎連接測試 ✅
- [x] `simple_test.py` - 快速協議測試 ✅
- [x] `quick_verify_protocol.py` - 協議驗證工具

### 協議測試工具
- [x] `daly_bms_tester.py` - DALY BMS 專用測試
- [x] `smart_bms_tester.py` - Smart BMS 協議測試
- [x] `protocol_brute_force.py` - 協議暴力測試
- [x] `smart_protocol_explorer.py` - AI 智能協議探測

### 分析工具
- [x] `characteristic_tester.py` - 特徵值分析
- [x] `bluetooth_sniffer.py` - 藍牙監聽工具
- [x] `hci_log_analyzer.py` - HCI 日誌分析
- [x] `android_hci_guide.md` - Android HCI 擷取指南

### 除錯工具
- [x] `daly_debug_tool.py` - DALY 除錯工具
- [x] `daly_diagnosis_tool.py` - DALY 診斷工具
- [x] `protocol_breaker.py` - 協議破解工具

---

## 📝 待辦事項

### 🔴 高優先級
- [ ] **破解回音問題**
  - [ ] 嘗試不同的寫入模式 (with/without response)
  - [ ] 測試不同的命令間隔時間
  - [ ] 探測是否需要初始化握手

- [ ] **協議初始化**
  - [ ] 測試認證序列 (可能需要密碼)
  - [ ] 嘗試喚醒命令
  - [ ] 探測正確的通訊流程

### 🟡 中優先級
- [ ] **Android HCI 日誌分析**
  - [ ] 擷取 Smart BMS app 的實際通訊
  - [ ] 分析完整的命令序列
  - [ ] 找出缺失的初始化步驟

- [ ] **擴展命令測試**
  - [ ] 測試其他 A5 命令 (0x90-0x98)
  - [ ] 嘗試讀取電芯電壓 (0x95)
  - [ ] 嘗試讀取溫度數據 (0x96)

### 🟢 低優先級
- [ ] 優化工具整合
- [ ] 建立完整的 BMS 通訊庫
- [ ] 實現即時監控界面
- [ ] 加入數據記錄功能

---

## 💡 下一步建議

### 立即行動
1. **測試寫入模式變化**
   ```python
   # 嘗試 with response=True
   await client.write_gatt_char(write_char, command, response=True)
   ```

2. **增加命令間延遲**
   ```python
   # 發送多個命令測試
   commands = ["A58090...", "A58091...", "A58093..."]
   for cmd in commands:
       await send_and_wait(cmd)
       await asyncio.sleep(0.5)
   ```

3. **嘗試初始化序列**
   ```python
   # 可能的握手/喚醒命令
   wake_commands = [
       "A5000000000000000000000000",  # 全零喚醒
       "A5FF00000000000000000000FF",  # 特殊喚醒
   ]
   ```

### 長期計畫
1. 使用 Android HCI 日誌擷取真實協議
2. 逆向工程 Smart BMS app (如果合法)
3. 聯繫 DALY 官方獲取協議文檔
4. 嘗試其他 BMS app 看是否有不同協議

---

## 📌 備註

### 已知限制
- BLE 一次只能連接一個設備
- BMS 在閒置時會進入休眠模式
- VMware 藍牙可能有延遲問題

### 參考資源
- [DALY BMS 協議文檔](待尋找)
- [Smart BMS app](已安裝於手機)
- 原始 CAN 協議文檔: `BMS通訊腳本CAN_ver8標準_20240116.pdf`

---

## 📅 更新歷史
- 2025-08-28: 初始化 TODO 清單，記錄當前狀態
- 2025-08-28: 發現回音問題，需要進一步破解
- 2025-08-28: 重大突破！發現使用錯誤協議 (A5 80 vs DD A5)
- 2025-08-28: 從 Smart BMS app 截圖獲取硬體/軟體版本資訊
- 2025-08-28: 找到正確的通用中國 BMS 協議格式
- 2025-08-28: 修正校驗和算法，確認協議格式完全正確
- 2025-08-28: 確認持續回音問題，判斷為 MOSFET 保護模式相關