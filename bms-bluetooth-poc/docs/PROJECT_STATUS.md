# BMS 藍牙通訊專案狀態報告

## 🎯 專案目標

### 主要目標
建立與 DALY BMS「DL-411812013771」的藍牙通訊，讀取即時電池資料

### 具體需求
- 透過藍牙連接讀取電池狀態資料（電壓、電流、SOC、電芯電壓、溫度等）
- 使用 Python 實現（使用者較熟悉 Python）
- 參考使用者提供的 CAN 協議文件理解資料格式
- 驗證讀取的資料與 Smart BMS app 顯示一致

## 📊 已確認的硬體資訊

### BMS 設備資訊
- **型號**: DL-411812013771
- **製造商**: DALY BMS
- **韌體**: K00T（關鍵發現：使用 D2 Modbus 協議）
- **MAC 地址**: 41:18:12:01:37:71
- **電池配置**: 8S（8串）鋰電池包

### 已知電池狀態（來自 Smart BMS app）
- **總電壓**: 26.6V
- **充電狀態 (SOC)**: 49.8%
- **電芯數量**: 8 個電芯
- **溫度感測器**: 多個溫度點

## ✅ 技術突破

### 1. 藍牙連線成功
- **狀態**: ✅ 已解決
- **解決方案**: VMware 虛擬機藍牙設定，BLE 裝置掃描成功
- **關鍵特徵值**: 
  - 寫入特徵值: `0000fff2-0000-1000-8000-00805f9b34fb`
  - 讀取特徵值: `0000fff1-0000-1000-8000-00805f9b34fb`

### 2. 協議研究重大突破
- **狀態**: ✅ 已識別正確協議
- **發現**: BMS 使用 **D2 Modbus 協議**（非傳統 A5 或 DD A5 協議）
- **協議特徵**:
  - 8 位元組命令格式
  - Modbus RTU 標準
  - CRC-16 校驗碼
  - 設備地址: 0xD2
  - 功能碼: 0x03（讀取保持寄存器）

### 3. AI 協議探索成功
- **狀態**: ✅ 發現有效命令
- **工具**: `smart_protocol_explorer.py`（使用遺傳演算法）
- **發現的高分命令**: `A58093080000000000000000C0`（評分 50）
- **意義**: 突破了 echo 效應，識別出能產生實際資料回應的命令

## 🛠️ 開發的工具

### 核心測試工具
1. **`scanner.py`** - 藍牙設備掃描器
2. **`daly_d2_modbus_test.py`** - D2 Modbus 協議完整實現
3. **`smart_protocol_explorer.py`** - AI 驅動的協議探索工具
4. **`quick_d2_test.py`** - 快速 D2 測試工具

### 寄存器映射表（D2 Modbus）
```python
registers = {
    "cell_voltage_base": 0x0000,  # 電芯電壓起始地址
    "temperature_base": 0x0020,   # 溫度起始地址  
    "total_voltage": 0x0028,      # 總電壓
    "current": 0x0029,            # 電流
    "fault_bitmap": 0x003A,       # 故障狀態
    "soc": 0x002C,               # SOC
    "mosfet_status": 0x002D,     # MOSFET 狀態
}
```

## 🔬 技術分析發現

### 協議識別過程
1. **初期**: 嘗試標準 Smart BMS 協議（DD A5 格式）→ 無效
2. **中期**: 發現所有命令產生 echo 效應
3. **突破**: AI 分析發現 echo 中包含實際資料
4. **確認**: 網路研究確認 K00T 韌體使用 D2 Modbus

### CAN 協議文件分析
從使用者提供的 `BMS通訊腳本CAN_ver8標準_20240116.pdf` 得到重要資訊：
- BMS 有休眠機制（3-65535秒可配置）
- 喚醒條件包括「上位機連線」
- 資料格式：0.1V/A/% 縮放比例
- MOSFET 控制邏輯

## ⚠️ 當前挑戰

### 1. BMS 休眠問題
- **問題**: BMS 會進入休眠狀態，導致連線失敗
- **影響**: 連線時機必須精確掌握
- **狀態**: 🔄 研究中

### 2. 殭屍連線問題  
- **問題**: BLE 連線卡住，無法建立新連線
- **解決方案**: 使用 `bluetoothctl disconnect` 清除
- **狀態**: ⚠️ 需要手動處理

### 3. 協議驗證 ✅
- **狀態**: ✅ 已完成
- **結果**: D2 Modbus 協議完全成功
- **驗證數據**: 總電壓 26.5V (vs 目標 26.6V, 差異僅0.1V)
- **電流解析**: 成功修正偏移編碼，靜止狀態 0.0A

## 📋 下一步行動計劃

### 優先級 1: 協議驗證 ✅ 已完成
1. ✅ D2 Modbus 協議測試成功
2. ✅ 電壓數值驗證通過 (26.5V vs 26.6V)
3. ✅ 電芯電壓、溫度數據正常讀取
4. ✅ 電流解析修正完成 (偏移編碼)

### 優先級 2: 穩定連線
1. 解決 BMS 休眠時機問題
2. 實現自動重連機制
3. 處理殭屍連線清理

### 優先級 3: 完整監控系統
1. 建立即時資料讀取
2. 實現資料視覺化
3. 新增歷史資料記錄

## 🎯 成功指標

### 短期目標（當前週期）
- [x] D2 Modbus 協議成功讀取電池資料 ✅
- [x] 資料數值與 Smart BMS app 一致 ✅
- [ ] 穩定的連線重建機制

### 長期目標
- [ ] 完整的電池監控界面
- [ ] 即時資料串流
- [ ] 警報和保護狀態監控

## 📚 技術資源

### 已建立的知識庫
- DALY BMS D2 Modbus 協議實現
- AI 驅動的協議探索方法
- BLE 連線和特徵值操作
- CAN 協議到藍牙協議的對應關係

### 限制條件
- 無 Android 設備進行 HCI 日誌分析
- 僅有 CAN 協議文件，無藍牙協議官方文件
- VMware 虛擬機環境的藍牙限制

## 🔍 關鍵技術細節

### D2 Modbus 命令構建
```python
def build_modbus_read_command(self, register_addr, num_registers=1):
    packet = [
        self.device_addr,              # 0xD2
        0x03,                          # 功能碼：讀取保持寄存器
        (register_addr >> 8) & 0xFF,   # 起始地址高位元組
        register_addr & 0xFF,          # 起始地址低位元組
        (num_registers >> 8) & 0xFF,   # 寄存器數量高位元組
        num_registers & 0xFF           # 寄存器數量低位元組
    ]
    
    # 計算 CRC-16
    crc = self.calculate_modbus_crc16(packet)
    packet.extend([crc & 0xFF, (crc >> 8) & 0xFF])
    
    return bytes(packet)
```

---

**最後更新**: 2025-08-28
**專案狀態**: 🎉 協議實現與驗證完全成功