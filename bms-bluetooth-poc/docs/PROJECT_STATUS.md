# BMS è—ç‰™é€šè¨Šå°ˆæ¡ˆç‹€æ…‹å ±å‘Š

## ğŸ¯ å°ˆæ¡ˆç›®æ¨™

### ä¸»è¦ç›®æ¨™
å»ºç«‹èˆ‡ DALY BMSã€ŒDL-411812013771ã€çš„è—ç‰™é€šè¨Šï¼Œè®€å–å³æ™‚é›»æ± è³‡æ–™

### å…·é«”éœ€æ±‚
- é€éè—ç‰™é€£æ¥è®€å–é›»æ± ç‹€æ…‹è³‡æ–™ï¼ˆé›»å£“ã€é›»æµã€SOCã€é›»èŠ¯é›»å£“ã€æº«åº¦ç­‰ï¼‰
- ä½¿ç”¨ Python å¯¦ç¾ï¼ˆä½¿ç”¨è€…è¼ƒç†Ÿæ‚‰ Pythonï¼‰
- åƒè€ƒä½¿ç”¨è€…æä¾›çš„ CAN å”è­°æ–‡ä»¶ç†è§£è³‡æ–™æ ¼å¼
- é©—è­‰è®€å–çš„è³‡æ–™èˆ‡ Smart BMS app é¡¯ç¤ºä¸€è‡´

## ğŸ“Š å·²ç¢ºèªçš„ç¡¬é«”è³‡è¨Š

### BMS è¨­å‚™è³‡è¨Š
- **å‹è™Ÿ**: DL-411812013771
- **è£½é€ å•†**: DALY BMS
- **éŸŒé«”**: K00Tï¼ˆé—œéµç™¼ç¾ï¼šä½¿ç”¨ D2 Modbus å”è­°ï¼‰
- **MAC åœ°å€**: 41:18:12:01:37:71
- **é›»æ± é…ç½®**: 8Sï¼ˆ8ä¸²ï¼‰é‹°é›»æ± åŒ…

### å·²çŸ¥é›»æ± ç‹€æ…‹ï¼ˆä¾†è‡ª Smart BMS appï¼‰
- **ç¸½é›»å£“**: 26.6V
- **å……é›»ç‹€æ…‹ (SOC)**: 49.8%
- **é›»èŠ¯æ•¸é‡**: 8 å€‹é›»èŠ¯
- **æº«åº¦æ„Ÿæ¸¬å™¨**: å¤šå€‹æº«åº¦é»

## âœ… æŠ€è¡“çªç ´

### 1. è—ç‰™é€£ç·šæˆåŠŸ
- **ç‹€æ…‹**: âœ… å·²è§£æ±º
- **è§£æ±ºæ–¹æ¡ˆ**: VMware è™›æ“¬æ©Ÿè—ç‰™è¨­å®šï¼ŒBLE è£ç½®æƒææˆåŠŸ
- **é—œéµç‰¹å¾µå€¼**: 
  - å¯«å…¥ç‰¹å¾µå€¼: `0000fff2-0000-1000-8000-00805f9b34fb`
  - è®€å–ç‰¹å¾µå€¼: `0000fff1-0000-1000-8000-00805f9b34fb`

### 2. å”è­°ç ”ç©¶é‡å¤§çªç ´
- **ç‹€æ…‹**: âœ… å·²è­˜åˆ¥æ­£ç¢ºå”è­°
- **ç™¼ç¾**: BMS ä½¿ç”¨ **D2 Modbus å”è­°**ï¼ˆéå‚³çµ± A5 æˆ– DD A5 å”è­°ï¼‰
- **å”è­°ç‰¹å¾µ**:
  - 8 ä½å…ƒçµ„å‘½ä»¤æ ¼å¼
  - Modbus RTU æ¨™æº–
  - CRC-16 æ ¡é©—ç¢¼
  - è¨­å‚™åœ°å€: 0xD2
  - åŠŸèƒ½ç¢¼: 0x03ï¼ˆè®€å–ä¿æŒå¯„å­˜å™¨ï¼‰

### 3. AI å”è­°æ¢ç´¢æˆåŠŸ
- **ç‹€æ…‹**: âœ… ç™¼ç¾æœ‰æ•ˆå‘½ä»¤
- **å·¥å…·**: `smart_protocol_explorer.py`ï¼ˆä½¿ç”¨éºå‚³æ¼”ç®—æ³•ï¼‰
- **ç™¼ç¾çš„é«˜åˆ†å‘½ä»¤**: `A58093080000000000000000C0`ï¼ˆè©•åˆ† 50ï¼‰
- **æ„ç¾©**: çªç ´äº† echo æ•ˆæ‡‰ï¼Œè­˜åˆ¥å‡ºèƒ½ç”¢ç”Ÿå¯¦éš›è³‡æ–™å›æ‡‰çš„å‘½ä»¤

## ğŸ› ï¸ é–‹ç™¼çš„å·¥å…·

### æ ¸å¿ƒæ¸¬è©¦å·¥å…·
1. **`scanner.py`** - è—ç‰™è¨­å‚™æƒæå™¨
2. **`daly_d2_modbus_test.py`** - D2 Modbus å”è­°å®Œæ•´å¯¦ç¾
3. **`smart_protocol_explorer.py`** - AI é©…å‹•çš„å”è­°æ¢ç´¢å·¥å…·
4. **`quick_d2_test.py`** - å¿«é€Ÿ D2 æ¸¬è©¦å·¥å…·

### å¯„å­˜å™¨æ˜ å°„è¡¨ï¼ˆD2 Modbusï¼‰
```python
registers = {
    "cell_voltage_base": 0x0000,  # é›»èŠ¯é›»å£“èµ·å§‹åœ°å€
    "temperature_base": 0x0020,   # æº«åº¦èµ·å§‹åœ°å€  
    "total_voltage": 0x0028,      # ç¸½é›»å£“
    "current": 0x0029,            # é›»æµ
    "fault_bitmap": 0x003A,       # æ•…éšœç‹€æ…‹
    "soc": 0x002C,               # SOC
    "mosfet_status": 0x002D,     # MOSFET ç‹€æ…‹
}
```

## ğŸ”¬ æŠ€è¡“åˆ†æç™¼ç¾

### å”è­°è­˜åˆ¥éç¨‹
1. **åˆæœŸ**: å˜—è©¦æ¨™æº– Smart BMS å”è­°ï¼ˆDD A5 æ ¼å¼ï¼‰â†’ ç„¡æ•ˆ
2. **ä¸­æœŸ**: ç™¼ç¾æ‰€æœ‰å‘½ä»¤ç”¢ç”Ÿ echo æ•ˆæ‡‰
3. **çªç ´**: AI åˆ†æç™¼ç¾ echo ä¸­åŒ…å«å¯¦éš›è³‡æ–™
4. **ç¢ºèª**: ç¶²è·¯ç ”ç©¶ç¢ºèª K00T éŸŒé«”ä½¿ç”¨ D2 Modbus

### CAN å”è­°æ–‡ä»¶åˆ†æ
å¾ä½¿ç”¨è€…æä¾›çš„ `BMSé€šè¨Šè…³æœ¬CAN_ver8æ¨™æº–_20240116.pdf` å¾—åˆ°é‡è¦è³‡è¨Šï¼š
- BMS æœ‰ä¼‘çœ æ©Ÿåˆ¶ï¼ˆ3-65535ç§’å¯é…ç½®ï¼‰
- å–šé†’æ¢ä»¶åŒ…æ‹¬ã€Œä¸Šä½æ©Ÿé€£ç·šã€
- è³‡æ–™æ ¼å¼ï¼š0.1V/A/% ç¸®æ”¾æ¯”ä¾‹
- MOSFET æ§åˆ¶é‚è¼¯

## âš ï¸ ç•¶å‰æŒ‘æˆ°

### 1. BMS ä¼‘çœ å•é¡Œ
- **å•é¡Œ**: BMS æœƒé€²å…¥ä¼‘çœ ç‹€æ…‹ï¼Œå°è‡´é€£ç·šå¤±æ•—
- **å½±éŸ¿**: é€£ç·šæ™‚æ©Ÿå¿…é ˆç²¾ç¢ºæŒæ¡
- **ç‹€æ…‹**: ğŸ”„ ç ”ç©¶ä¸­

### 2. æ®­å±é€£ç·šå•é¡Œ  
- **å•é¡Œ**: BLE é€£ç·šå¡ä½ï¼Œç„¡æ³•å»ºç«‹æ–°é€£ç·š
- **è§£æ±ºæ–¹æ¡ˆ**: ä½¿ç”¨ `bluetoothctl disconnect` æ¸…é™¤
- **ç‹€æ…‹**: âš ï¸ éœ€è¦æ‰‹å‹•è™•ç†

### 3. å”è­°é©—è­‰ âœ…
- **ç‹€æ…‹**: âœ… å·²å®Œæˆ
- **çµæœ**: D2 Modbus å”è­°å®Œå…¨æˆåŠŸ
- **é©—è­‰æ•¸æ“š**: ç¸½é›»å£“ 26.5V (vs ç›®æ¨™ 26.6V, å·®ç•°åƒ…0.1V)
- **é›»æµè§£æ**: æˆåŠŸä¿®æ­£åç§»ç·¨ç¢¼ï¼Œéœæ­¢ç‹€æ…‹ 0.0A

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡Œå‹•è¨ˆåŠƒ

### å„ªå…ˆç´š 1: å”è­°é©—è­‰ âœ… å·²å®Œæˆ
1. âœ… D2 Modbus å”è­°æ¸¬è©¦æˆåŠŸ
2. âœ… é›»å£“æ•¸å€¼é©—è­‰é€šé (26.5V vs 26.6V)
3. âœ… é›»èŠ¯é›»å£“ã€æº«åº¦æ•¸æ“šæ­£å¸¸è®€å–
4. âœ… é›»æµè§£æä¿®æ­£å®Œæˆ (åç§»ç·¨ç¢¼)

### å„ªå…ˆç´š 2: ç©©å®šé€£ç·š
1. è§£æ±º BMS ä¼‘çœ æ™‚æ©Ÿå•é¡Œ
2. å¯¦ç¾è‡ªå‹•é‡é€£æ©Ÿåˆ¶
3. è™•ç†æ®­å±é€£ç·šæ¸…ç†

### å„ªå…ˆç´š 3: å®Œæ•´ç›£æ§ç³»çµ±
1. å»ºç«‹å³æ™‚è³‡æ–™è®€å–
2. å¯¦ç¾è³‡æ–™è¦–è¦ºåŒ–
3. æ–°å¢æ­·å²è³‡æ–™è¨˜éŒ„

## ğŸ¯ æˆåŠŸæŒ‡æ¨™

### çŸ­æœŸç›®æ¨™ï¼ˆç•¶å‰é€±æœŸï¼‰
- [x] D2 Modbus å”è­°æˆåŠŸè®€å–é›»æ± è³‡æ–™ âœ…
- [x] è³‡æ–™æ•¸å€¼èˆ‡ Smart BMS app ä¸€è‡´ âœ…
- [ ] ç©©å®šçš„é€£ç·šé‡å»ºæ©Ÿåˆ¶

### é•·æœŸç›®æ¨™
- [ ] å®Œæ•´çš„é›»æ± ç›£æ§ç•Œé¢
- [ ] å³æ™‚è³‡æ–™ä¸²æµ
- [ ] è­¦å ±å’Œä¿è­·ç‹€æ…‹ç›£æ§

## ğŸ“š æŠ€è¡“è³‡æº

### å·²å»ºç«‹çš„çŸ¥è­˜åº«
- DALY BMS D2 Modbus å”è­°å¯¦ç¾
- AI é©…å‹•çš„å”è­°æ¢ç´¢æ–¹æ³•
- BLE é€£ç·šå’Œç‰¹å¾µå€¼æ“ä½œ
- CAN å”è­°åˆ°è—ç‰™å”è­°çš„å°æ‡‰é—œä¿‚

### é™åˆ¶æ¢ä»¶
- ç„¡ Android è¨­å‚™é€²è¡Œ HCI æ—¥èªŒåˆ†æ
- åƒ…æœ‰ CAN å”è­°æ–‡ä»¶ï¼Œç„¡è—ç‰™å”è­°å®˜æ–¹æ–‡ä»¶
- VMware è™›æ“¬æ©Ÿç’°å¢ƒçš„è—ç‰™é™åˆ¶

## ğŸ” é—œéµæŠ€è¡“ç´°ç¯€

### D2 Modbus å‘½ä»¤æ§‹å»º
```python
def build_modbus_read_command(self, register_addr, num_registers=1):
    packet = [
        self.device_addr,              # 0xD2
        0x03,                          # åŠŸèƒ½ç¢¼ï¼šè®€å–ä¿æŒå¯„å­˜å™¨
        (register_addr >> 8) & 0xFF,   # èµ·å§‹åœ°å€é«˜ä½å…ƒçµ„
        register_addr & 0xFF,          # èµ·å§‹åœ°å€ä½ä½å…ƒçµ„
        (num_registers >> 8) & 0xFF,   # å¯„å­˜å™¨æ•¸é‡é«˜ä½å…ƒçµ„
        num_registers & 0xFF           # å¯„å­˜å™¨æ•¸é‡ä½ä½å…ƒçµ„
    ]
    
    # è¨ˆç®— CRC-16
    crc = self.calculate_modbus_crc16(packet)
    packet.extend([crc & 0xFF, (crc >> 8) & 0xFF])
    
    return bytes(packet)
```

---

**æœ€å¾Œæ›´æ–°**: 2025-08-28
**å°ˆæ¡ˆç‹€æ…‹**: ğŸ‰ å”è­°å¯¦ç¾èˆ‡é©—è­‰å®Œå…¨æˆåŠŸ